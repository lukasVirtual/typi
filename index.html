<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>typi — typing speed test</title>
  <meta name="description" content="typi is a minimal typing speed test with 15s, 30s, and 60s modes. Measure your WPM and accuracy instantly.">
  <meta name="robots" content="index, follow">
  <meta name="keywords" content="typing test, typing speed test, wpm test, typing accuracy, keyboard practice">
  <meta property="og:type" content="website">
  <meta property="og:title" content="typi — typing speed test">
  <meta property="og:description" content="Measure your words per minute and accuracy with a clean, fast typing test.">
  <meta property="og:site_name" content="typi">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="typi — typing speed test">
  <meta name="twitter:description" content="Measure your words per minute and accuracy with a clean, fast typing test.">
  <meta name="theme-color" content="#0f0f0f">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:       #0f0f0f;
      --surface:  #181818;
      --border:   #242424;
      --muted:    #3a3a3a;
      --dim:      #555;
      --text:     #c8c8c8;
      --accent:   #e8d5a3;
      --correct:  #7ec8a0;
      --wrong:    #e07070;
      --cursor:   #e8d5a3;
      --mono:     'DM Mono', monospace;
      --sans:     'DM Sans', sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      -webkit-font-smoothing: antialiased;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 2rem;
    }

    /* ── Header ── */
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 2.5rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      z-index: 10;
    }

    .logo {
      font-family: var(--mono);
      font-size: 1rem;
      font-weight: 500;
      color: var(--accent);
      letter-spacing: -0.02em;
    }

    .logo span { color: var(--dim); font-weight: 300; }

    /* ── Main container ── */
    main {
      width: 100%;
      max-width: 920px;
      display: flex;
      flex-direction: column;
      gap: 2.5rem;
    }

    /* ── Stats bar ── */
    .stats {
      display: flex;
      gap: 2.5rem;
      align-items: baseline;
    }

    .stat {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .stat-value {
      font-family: var(--mono);
      font-size: 2rem;
      font-weight: 300;
      color: var(--accent);
      line-height: 1;
      transition: color 0.2s;
    }

    .stat-label {
      font-size: 0.65rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--dim);
      font-weight: 500;
    }

    .stat-value.timer-urgent { color: var(--wrong); }

    /* ── Word display ── */
    #word-display {
      position: relative;
      font-family: var(--mono);
      font-size: 1.5rem;
      line-height: 2.6rem;
      color: var(--muted);
      letter-spacing: 0.01em;
      height: calc(2.6rem * 4);
      overflow: hidden;
      cursor: text;
      user-select: none;
    }

    #words-inner {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      gap: 0 0.55em;
      transition: top 0.07s ease-out;
    }

    .word {
      display: inline-flex;
      position: relative;
      white-space: nowrap;
      transition: none;
    }

    .char {
      transition: color 0.05s ease;
    }

    .word.extra-wrong::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 2px;
      background: var(--wrong);
      border-radius: 1px;
    }

    .char { position: relative; }
    .char.correct { color: var(--correct); }
    .char.wrong   { color: var(--wrong); }
    .char.pending { color: var(--muted); }

    /* Cursor */
    .cursor-beam {
      display: inline-block;
      width: 2px;
      background: var(--cursor);
      position: absolute;
      border-radius: 1px;
      pointer-events: none;
      animation: blink 1.1s step-end infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0; }
    }

    /* ── Hidden input ── */
    #hidden-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
      width: 1px;
      height: 1px;
    }

    /* ── Start overlay ── */
    #start-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(to bottom, transparent 0%, var(--bg) 80%);
      pointer-events: none;
    }

    .start-hint {
      font-family: var(--mono);
      font-size: 0.8rem;
      color: var(--dim);
      letter-spacing: 0.08em;
      animation: pulse 2.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50%       { opacity: 1; }
    }

    /* ── Controls ── */
    .controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 1.1rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--dim);
      font-family: var(--mono);
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn:hover {
      border-color: var(--muted);
      color: var(--text);
      background: var(--surface);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn svg { flex-shrink: 0; }

    /* ── Results overlay ── */
    #results {
      display: none;
      flex-direction: column;
      gap: 2.5rem;
      animation: fadeUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) both;
    }

    #results.visible { display: flex; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .results-title {
      font-family: var(--mono);
      font-size: 0.7rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--dim);
    }

    .results-big {
      display: flex;
      gap: 3rem;
      align-items: baseline;
    }

    .result-item {}
    .result-num {
      font-family: var(--mono);
      font-size: 4.5rem;
      font-weight: 300;
      color: var(--accent);
      line-height: 1;
    }

    .result-unit {
      font-size: 0.8rem;
      color: var(--dim);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-top: 0.35rem;
    }

    .result-sub {
      display: flex;
      gap: 2rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .result-sub-item {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .result-sub-value {
      font-family: var(--mono);
      font-size: 1.2rem;
      font-weight: 300;
      color: var(--text);
    }

    .result-sub-label {
      font-size: 0.65rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--dim);
    }

    .share-preview-wrap {
      display: none;
      flex-direction: column;
      gap: 0.75rem;
    }

    .share-preview-wrap.visible {
      display: flex;
    }

    .share-preview-head {
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--dim);
    }

    .share-preview-frame {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--surface);
      padding: 0.6rem;
    }

    #share-preview {
      width: 100%;
      display: block;
      border-radius: 6px;
      background: #0f0f0f;
      aspect-ratio: 1200 / 630;
      object-fit: cover;
    }

    .share-preview-status {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--muted);
    }

    /* ── Typing area wrapper ── */
    #typing-area {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 2.5rem;
    }

    /* ── Time mode selector ── */
    .time-modes {
      display: flex;
      gap: 0.25rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 0.2rem;
    }

    .time-btn {
      padding: 0.3rem 0.75rem;
      border-radius: 5px;
      border: none;
      background: transparent;
      color: var(--dim);
      font-family: var(--mono);
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.15s;
    }

    .time-btn:hover { color: var(--text); }

    .time-btn.active {
      background: var(--border);
      color: var(--accent);
    }

    /* ── Responsive ── */
    @media (max-width: 600px) {
      #word-display { font-size: 1.1rem; line-height: 2rem; height: calc(2rem * 4); }
      .stat-value { font-size: 1.5rem; }
      .result-num { font-size: 3rem; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">typi<span>.test</span></div>
  <div class="time-modes" id="time-modes">
    <button class="time-btn" data-duration="15">15s</button>
    <button class="time-btn" data-duration="30">30s</button>
    <button class="time-btn active" data-duration="60">60s</button>
  </div>
</header>

<main>
  <!-- Live stats -->
  <div class="stats" id="live-stats">
    <div class="stat">
      <div class="stat-value" id="wpm-display">—</div>
      <div class="stat-label">wpm</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="acc-display">—</div>
      <div class="stat-label">accuracy</div>
    </div>
    <div class="stat" style="margin-left:auto">
      <div class="stat-value" id="timer-display">60</div>
      <div class="stat-label">seconds</div>
    </div>
  </div>

  <!-- Typing area -->
  <div id="typing-area">
    <div id="word-display" tabindex="0">
      <div id="words-inner"></div>
      <div class="cursor-beam" id="cursor"></div>
      <div id="start-overlay">
        <span class="start-hint">click here and start typing</span>
      </div>
    </div>
    <input id="hidden-input" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" aria-hidden="true">

    <!-- Controls -->
    <div class="controls">
      <button class="btn" id="restart-btn" title="Restart (Tab + Enter)">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M1 6a5 5 0 1 0 1.08-3.1" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          <path d="M1 2.5V6h3.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        restart
      </button>
      <span style="font-family:var(--mono);font-size:0.7rem;color:var(--muted)">tab + enter to reset</span>
    </div>
  </div>

  <!-- Results screen -->
  <div id="results">
    <div class="results-title">results</div>
    <div class="results-big">
      <div class="result-item">
        <div class="result-num" id="res-wpm">0</div>
        <div class="result-unit">wpm</div>
      </div>
      <div class="result-item">
        <div class="result-num" id="res-acc">0%</div>
        <div class="result-unit">accuracy</div>
      </div>
    </div>
    <div class="result-sub">
      <div class="result-sub-item">
        <div class="result-sub-value" id="res-correct">0</div>
        <div class="result-sub-label">correct chars</div>
      </div>
      <div class="result-sub-item">
        <div class="result-sub-value" id="res-wrong">0</div>
        <div class="result-sub-label">wrong chars</div>
      </div>
      <div class="result-sub-item">
        <div class="result-sub-value" id="res-words">0</div>
        <div class="result-sub-label">words typed</div>
      </div>
    </div>
    <div class="share-preview-wrap" id="share-preview-wrap">
      <div class="share-preview-head">share preview</div>
      <div class="share-preview-frame">
        <img id="share-preview" alt="Share image preview for typing test score">
      </div>
      <div class="share-preview-status" id="share-preview-status">building preview...</div>
    </div>
    <div class="controls">
      <button class="btn" id="retry-btn">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M1 6a5 5 0 1 0 1.08-3.1" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          <path d="M1 2.5V6h3.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        try again
      </button>
      <button class="btn" id="download-btn">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 1.5v5.6" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          <path d="M3.8 5.7 6 8l2.2-2.3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M1.8 9.8h8.4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
        </svg>
        download image
      </button>
      <button class="btn" id="share-btn">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="8.9" cy="2.5" r="1.4" stroke="currentColor" stroke-width="1.4"/>
          <circle cx="3.1" cy="5.9" r="1.4" stroke="currentColor" stroke-width="1.4"/>
          <circle cx="8.9" cy="9.5" r="1.4" stroke="currentColor" stroke-width="1.4"/>
          <path d="M4.4 5.2 7.5 3.2M4.4 6.6 7.5 8.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
        </svg>
        share image
      </button>
    </div>
  </div>
</main>

<script>
// ─── Word pool ─────────────────────────────────────────────────────────────
const WORDS = [
  "the","be","to","of","and","a","in","that","have","it","for","not","on",
  "with","he","as","you","do","at","this","but","his","by","from","they",
  "we","say","her","she","or","an","will","my","one","all","would","there",
  "their","what","so","up","out","if","about","who","get","which","go","me",
  "when","make","can","like","time","no","just","him","know","take","people",
  "into","year","your","good","some","could","them","see","other","than",
  "then","now","look","only","come","its","over","think","also","back","after",
  "use","two","how","our","work","first","well","way","even","new","want",
  "because","any","these","give","day","most","us","great","between","need",
  "large","often","hand","high","place","hold","turn","where","much","before",
  "move","right","boy","old","too","same","tell","does","set","three","want",
  "air","play","small","number","off","always","next","open","seem","together",
  "start","stop","city","earth","eye","light","thought","head","under","story",
  "saw","left","don","few","those","show","got","near","add","food","between",
  "own","below","country","plant","last","school","father","keep","tree","never",
  "start","city","earth","eyes","light","thought","night","head","under","story",
  "short","sea","learn","plant","cover","food","sun","four","between","state",
  "keep","never","last","door","body","music","color","stand","sun","questions",
  "fish","area","mark","book","letter","until","mile","river","car","feet",
  "care","second","enough","plain","girl","usual","young","ready","above",
  "ever","red","list","though","feel","talk","bird","soon","body","dog","family",
  "direct","pose","leave","song","measure","product","black","short","numeral",
  "class","wind","question","happen","complete","ship","area","half","rock",
  "order","fire","south","problem","piece","told","knew","pass","since","top",
  "whole","king","space","heard","best","hour","better","during","blue","five",
  "brought","though","deep","force","truly","thousand","ago","ran","check",
  "game","shape","against","fell","hot","miss","road","arm","horse","bring",
  "sit","act","warm","voice","power","town","fine","drive","warm","bright",
  "lead","sing","surface","produce","building","ocean","class","note","nothing",
  "rest","carefully","scientists","inside","wheels","stay","green","known",
  "island","week","less","machine","base","ago","stood","plane","system",
  "behind","ran","round","boat","game","force","brought","understand","warm",
  "common","bring","explain","dry","though","language","shape","deep","thousands",
  "yes","clear","equation","carry","hit","ground","interest","reach","fast",
  "verb","sing","listen","six","table","travel","less","morning","ten","simple",
  "several","vowel","toward","war","lay","against","pattern","slow","center",
  "love","person","money","serve","appear","road","map","rain","rule","govern",
  "pull","cold","notice","voice","fall","power","town","fine","drive","full",
  "blue","object","decide","surface","deep","moon","island","foot","system",
  "busy","test","record","boat","common","gold","possible","plane","age","dry",
  "wonder","laugh","thousand","ago","ran","check","game","shape","meet","fall"
];

// deduplicate
const WORD_POOL = [...new Set(WORDS)];

// ─── State ──────────────────────────────────────────────────────────────────
let DURATION = 60;
const DURATION_STORAGE_KEY = 'typi_duration_seconds';
const ALLOWED_DURATIONS = new Set([15, 30, 60]);

let words        = [];
let wordEls      = [];
let charEls      = [];   // per word: array of char spans
let currentWord  = 0;
let currentChar  = 0;
let typed        = '';
let started      = false;
let finished     = false;
let startTime    = null;
let timerID      = null;
let timeLeft     = DURATION;
let correctChars = 0;
let wrongChars   = 0;
let totalTyped   = 0;
let tabDown      = false;
let wordsCompleted = 0;
let lastResult = null;
let lastShareBlob = null;
let lastShareUrl = '';

// ─── DOM refs ───────────────────────────────────────────────────────────────
const wordDisplay  = document.getElementById('word-display');
const wordsInner   = document.getElementById('words-inner');
const cursor       = document.getElementById('cursor');
const hiddenInput  = document.getElementById('hidden-input');
const startOverlay = document.getElementById('start-overlay');
const wpmDisplay   = document.getElementById('wpm-display');
const accDisplay   = document.getElementById('acc-display');
const timerDisplay = document.getElementById('timer-display');
const typingArea   = document.getElementById('typing-area');
const resultsEl    = document.getElementById('results');
const liveStats    = document.getElementById('live-stats');
const restartBtn   = document.getElementById('restart-btn');
const retryBtn     = document.getElementById('retry-btn');
const downloadBtn  = document.getElementById('download-btn');
const shareBtn     = document.getElementById('share-btn');
const sharePreviewWrap = document.getElementById('share-preview-wrap');
const sharePreviewImg = document.getElementById('share-preview');
const sharePreviewStatus = document.getElementById('share-preview-status');

// ─── Generate word list ─────────────────────────────────────────────────────
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function generateWords(n = 120) {
  const shuffled = shuffle(WORD_POOL);
  const result = [];
  while (result.length < n) result.push(...shuffled);
  return result.slice(0, n);
}

// ─── Build DOM ──────────────────────────────────────────────────────────────
function buildDisplay() {
  words = generateWords(120);
  wordsInner.innerHTML = '';
  wordEls = [];
  charEls = [];

  words.forEach((word, wi) => {
    const wordEl = document.createElement('span');
    wordEl.className = 'word';
    wordEl.dataset.index = wi;

    const chars = [];
    word.split('').forEach(ch => {
      const span = document.createElement('span');
      span.className = 'char pending';
      span.textContent = ch;
      wordEl.appendChild(span);
      chars.push(span);
    });

    wordsInner.appendChild(wordEl);
    wordEls.push(wordEl);
    charEls.push(chars);
  });

  wordsInner.style.top = '0px';
  placeCursor();
}

// ─── Cursor placement ───────────────────────────────────────────────────────
function placeCursor() {
  const wordEl = wordEls[currentWord];
  if (!wordEl) return;

  const chars = charEls[currentWord];
  const afterEnd = currentChar >= chars.length;
  const refEl = afterEnd ? chars[chars.length - 1] : chars[currentChar];

  const displayRect = wordDisplay.getBoundingClientRect();
  const refRect     = refEl.getBoundingClientRect();

  // Size cursor to font-size (not line-height) and center it in the line
  const fontSize    = parseFloat(getComputedStyle(wordDisplay).fontSize);
  const cursorH     = Math.round(fontSize * 1.15);
  const left        = (refRect.left - displayRect.left) + (afterEnd ? refRect.width : 0);
  const top         = (refRect.top - displayRect.top) + (refRect.height - cursorH) / 2;

  cursor.style.left   = left + 'px';
  cursor.style.top    = top + 'px';
  cursor.style.height = cursorH + 'px';

  // Restart blink animation so cursor is always visible right after a keypress
  cursor.style.animation = 'none';
  cursor.offsetHeight; // force reflow
  cursor.style.animation = '';

  scrollToCurrentWord();
}

function scrollToCurrentWord() {
  const wordEl = wordEls[currentWord];
  if (!wordEl) return;

  const displayRect = wordDisplay.getBoundingClientRect();
  const wordRect    = wordEl.getBoundingClientRect();
  const lineH = parseFloat(getComputedStyle(wordDisplay).lineHeight) || 35;

  // Figure out which row the current word is on
  const relTop = wordRect.top - displayRect.top;
  const currentTop = parseFloat(wordsInner.style.top) || 0;

  // If the word is on or below the 2nd line (lineH), scroll so it appears on line 1
  if (relTop >= lineH * 1.8) {
    wordsInner.style.top = (currentTop - lineH) + 'px';
  }
}

// ─── Start timer ────────────────────────────────────────────────────────────
function startTimer() {
  startTime = Date.now();
  timerID = setInterval(() => {
    timeLeft = Math.max(0, DURATION - Math.round((Date.now() - startTime) / 1000));
    timerDisplay.textContent = timeLeft;

    const urgentThreshold = DURATION <= 15 ? 5 : DURATION <= 30 ? 8 : 10;
    if (timeLeft <= urgentThreshold) timerDisplay.classList.add('timer-urgent');

    updateStats();

    if (timeLeft === 0) finishTest();
  }, 200);
}

// ─── Update live stats ───────────────────────────────────────────────────────
function updateStats() {
  if (!startTime) return;
  const elapsed = (Date.now() - startTime) / 60000; // minutes
  // Standard formula: correct chars / 5 / minutes (5 = standardized avg word length)
  const wpm = elapsed > 0 ? Math.round((correctChars / 5) / elapsed) : 0;
  const total = correctChars + wrongChars;
  const acc = total > 0 ? Math.round((correctChars / total) * 100) : 100;

  wpmDisplay.textContent = wpm;
  accDisplay.textContent = acc + '%';
}

// ─── Input handling ──────────────────────────────────────────────────────────
hiddenInput.addEventListener('input', handleInput);

function handleInput(e) {
  if (finished) return;

  if (!started) {
    started = true;
    startOverlay.style.display = 'none';
    cursor.style.animationPlayState = 'paused';
    setTimeout(() => cursor.style.animationPlayState = 'running', 500);
    startTimer();
  }

  const val = hiddenInput.value;

  // Space = advance to next word
  if (val.endsWith(' ')) {
    advanceWord();
    hiddenInput.value = '';
    typed = '';
    return;
  }

  typed = val;
  renderCurrentWord();
  placeCursor();
  updateStats();
}

function renderCurrentWord() {
  const word = words[currentWord];
  const chars = charEls[currentWord];

  chars.forEach((span, i) => {
    if (i < typed.length) {
      if (typed[i] === word[i]) {
        span.className = 'char correct';
      } else {
        span.className = 'char wrong';
      }
    } else {
      span.className = 'char pending';
    }
  });

  currentChar = typed.length;

  // Handle extra characters typed beyond word length
  const wordEl = wordEls[currentWord];
  if (typed.length > word.length) {
    wordEl.classList.add('extra-wrong');
  } else {
    wordEl.classList.remove('extra-wrong');
  }
}

function advanceWord() {
  const word = words[currentWord];
  const correct = typed === word;

  // Count characters
  const len = Math.min(typed.length, word.length);
  for (let i = 0; i < len; i++) {
    if (typed[i] === word[i]) correctChars++;
    else wrongChars++;
  }
  // Extra chars count as wrong
  if (typed.length > word.length) {
    wrongChars += typed.length - word.length;
  }
  // Space between words counts as a correct keystroke when word is right
  if (correct) correctChars++;

  // Mark completed word
  const el = wordEls[currentWord];
  el.style.transition = 'none';
  el.style.opacity = '0.5';
  if (correct) {
    wordsCompleted++;
  } else {
    el.classList.add('extra-wrong');
    charEls[currentWord].forEach((span, i) => {
      if (i < typed.length) {
        span.style.transition = 'none';
        span.className = typed[i] === word[i] ? 'char correct' : 'char wrong';
      }
    });
  }

  currentWord++;
  currentChar = 0;
  typed = '';

  if (currentWord >= words.length) finishTest();
  else placeCursor();
}

// ─── Finish ──────────────────────────────────────────────────────────────────
function finishTest() {
  if (finished) return;
  finished = true;
  clearInterval(timerID);
  hiddenInput.blur();

  const elapsed = (Date.now() - startTime) / 60000;
  const wpm = elapsed > 0 ? Math.round((correctChars / 5) / elapsed) : 0;
  const total = correctChars + wrongChars;
  const acc = total > 0 ? Math.round((correctChars / total) * 100) : 100;
  lastResult = {
    wpm,
    acc,
    correctChars,
    wrongChars,
    wordsCompleted,
    duration: DURATION
  };

  // Show results
  typingArea.style.display = 'none';
  liveStats.style.display  = 'none';
  resultsEl.classList.add('visible');

  document.getElementById('res-wpm').textContent     = wpm;
  document.getElementById('res-acc').textContent     = acc + '%';
  document.getElementById('res-correct').textContent = correctChars;
  document.getElementById('res-wrong').textContent   = wrongChars;
  document.getElementById('res-words').textContent   = wordsCompleted;
  buildSharePreview();
}

function createShareImageBlob(result) {
  return new Promise((resolve, reject) => {
    const canvas = document.createElement('canvas');
    canvas.width = 1200;
    canvas.height = 630;
    const ctx = canvas.getContext('2d');
    if (!ctx) {
      reject(new Error('Canvas is not supported in this browser.'));
      return;
    }

    const gradient = ctx.createLinearGradient(0, 0, 1200, 630);
    gradient.addColorStop(0, '#0f0f0f');
    gradient.addColorStop(1, '#1b1a17');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = 'rgba(232, 213, 163, 0.10)';
    ctx.beginPath();
    ctx.arc(1020, 120, 200, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(140, 580, 260, 0, Math.PI * 2);
    ctx.fill();

    ctx.strokeStyle = '#242424';
    ctx.lineWidth = 2;
    ctx.strokeRect(38, 38, 1124, 554);

    ctx.fillStyle = '#555';
    ctx.font = '28px "DM Mono", monospace';
    ctx.fillText('typi.test', 86, 110);

    ctx.fillStyle = '#e8d5a3';
    ctx.font = '700 168px "DM Sans", sans-serif';
    ctx.fillText(String(result.wpm), 82, 290);

    ctx.fillStyle = '#c8c8c8';
    ctx.font = '44px "DM Mono", monospace';
    ctx.fillText('WPM', 392, 286);

    ctx.fillStyle = '#555';
    ctx.font = '26px "DM Sans", sans-serif';
    ctx.fillText(`Accuracy ${result.acc}%`, 86, 354);
    ctx.fillText(`Mode ${result.duration}s`, 86, 392);
    ctx.fillText('typi typing speed test', 86, 430);

    const statsX = 650;
    const statsY = 200;
    const cardW = 440;
    const cardH = 286;
    ctx.fillStyle = 'rgba(24, 24, 24, 0.9)';
    ctx.fillRect(statsX, statsY, cardW, cardH);
    ctx.strokeStyle = '#2a2a2a';
    ctx.strokeRect(statsX, statsY, cardW, cardH);

    ctx.fillStyle = '#555';
    ctx.font = '20px "DM Mono", monospace';
    ctx.fillText('RESULTS', statsX + 30, statsY + 50);

    ctx.fillStyle = '#c8c8c8';
    ctx.font = '32px "DM Sans", sans-serif';
    ctx.fillText(`Correct chars: ${result.correctChars}`, statsX + 30, statsY + 120);
    ctx.fillText(`Wrong chars: ${result.wrongChars}`, statsX + 30, statsY + 175);
    ctx.fillText(`Words typed: ${result.wordsCompleted}`, statsX + 30, statsY + 230);

    canvas.toBlob(blob => {
      if (!blob) {
        reject(new Error('Could not create image.'));
        return;
      }
      resolve(blob);
    }, 'image/png');
  });
}

function downloadShareImage(blob, wpm) {
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `typi-${wpm}wpm.png`;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

function setSharePreviewStatus(message) {
  sharePreviewStatus.textContent = message;
}

function clearSharePreview() {
  if (lastShareUrl) {
    URL.revokeObjectURL(lastShareUrl);
    lastShareUrl = '';
  }
  lastShareBlob = null;
  sharePreviewImg.removeAttribute('src');
  sharePreviewWrap.classList.remove('visible');
}

async function ensureShareBlob() {
  if (!lastResult) return null;
  if (lastShareBlob) return lastShareBlob;
  const blob = await createShareImageBlob(lastResult);
  lastShareBlob = blob;
  if (lastShareUrl) URL.revokeObjectURL(lastShareUrl);
  lastShareUrl = URL.createObjectURL(blob);
  sharePreviewImg.src = lastShareUrl;
  return blob;
}

async function buildSharePreview() {
  if (!lastResult) return;
  sharePreviewWrap.classList.add('visible');
  setSharePreviewStatus('building preview...');
  try {
    await ensureShareBlob();
    setSharePreviewStatus('ready to share');
  } catch {
    setSharePreviewStatus('preview unavailable in this browser');
  }
}

async function handleDownloadShareImage() {
  if (!lastResult) return;
  const originalText = downloadBtn.textContent;
  downloadBtn.disabled = true;
  downloadBtn.textContent = 'building image...';

  try {
    const blob = await ensureShareBlob();
    if (blob) downloadShareImage(blob, lastResult.wpm);
  } catch (err) {
    alert('Could not create image in this browser. Please try again.');
  } finally {
    downloadBtn.disabled = false;
    downloadBtn.textContent = originalText;
  }
}

async function handleShareScore() {
  if (!lastResult) return;
  const originalText = shareBtn.textContent;
  shareBtn.disabled = true;
  shareBtn.textContent = 'opening share...';

  try {
    const blob = await ensureShareBlob();
    if (!blob) return;
    const fileName = `typi-${lastResult.wpm}wpm.png`;
    const canUseFileShare =
      typeof File === 'function' &&
      typeof navigator.share === 'function' &&
      typeof navigator.canShare === 'function';

    if (canUseFileShare) {
      const file = new File([blob], fileName, { type: 'image/png' });
      if (navigator.canShare({ files: [file] })) {
        await navigator.share({
          title: 'My typi score',
          text: `I scored ${lastResult.wpm} WPM with ${lastResult.acc}% accuracy in ${lastResult.duration}s.`,
          files: [file]
        });
      } else {
        downloadShareImage(blob, lastResult.wpm);
      }
    } else {
      downloadShareImage(blob, lastResult.wpm);
    }
  } catch (err) {
    if (!(err && err.name === 'AbortError')) alert('Could not share image in this browser. Please try again.');
  } finally {
    shareBtn.disabled = false;
    shareBtn.textContent = originalText;
  }
}

// ─── Reset ───────────────────────────────────────────────────────────────────
function reset() {
  clearInterval(timerID);
  started      = false;
  finished     = false;
  startTime    = null;
  timeLeft     = DURATION;
  currentWord  = 0;
  currentChar  = 0;
  typed        = '';
  correctChars = 0;
  wrongChars   = 0;
  totalTyped   = 0;
  wordsCompleted = 0;
  lastResult = null;
  clearSharePreview();
  tabDown      = false;

  hiddenInput.value = '';

  timeLeft = DURATION;
  timerDisplay.textContent = DURATION;
  timerDisplay.classList.remove('timer-urgent');
  wpmDisplay.textContent = '—';
  accDisplay.textContent = '—';

  typingArea.style.display = '';
  liveStats.style.display  = '';
  resultsEl.classList.remove('visible');

  startOverlay.style.display = '';

  buildDisplay();
  hiddenInput.focus();
}

// ─── Focus management ────────────────────────────────────────────────────────
wordDisplay.addEventListener('click', () => hiddenInput.focus());
hiddenInput.addEventListener('focus', () => {
  cursor.style.opacity = '1';
});
hiddenInput.addEventListener('blur', () => {
  if (!started && !finished) cursor.style.animationPlayState = 'running';
});

// Tab + Enter shortcut
document.addEventListener('keydown', e => {
  if (e.key === 'Tab') {
    tabDown = true;
    e.preventDefault();
  }
  if (e.key === 'Enter' && tabDown) {
    e.preventDefault();
    reset();
  }
  // Backspace handling
  if (e.key === 'Backspace' && document.activeElement === hiddenInput) {
    // Let browser handle it, then re-render
    // (handled via input event)
  }
});

document.addEventListener('keyup', e => {
  if (e.key === 'Tab') tabDown = false;
});

restartBtn.addEventListener('click', reset);
retryBtn.addEventListener('click', reset);
downloadBtn.addEventListener('click', handleDownloadShareImage);
shareBtn.addEventListener('click', handleShareScore);

// ─── Time mode buttons ───────────────────────────────────────────────────────
function setDuration(duration, { persist = true, doReset = true } = {}) {
  if (!ALLOWED_DURATIONS.has(duration)) return;
  DURATION = duration;
  document.querySelectorAll('.time-btn').forEach(b => {
    b.classList.toggle('active', parseInt(b.dataset.duration, 10) === duration);
  });
  timerDisplay.textContent = DURATION;
  if (persist) {
    try {
      localStorage.setItem(DURATION_STORAGE_KEY, String(DURATION));
    } catch {}
  }
  if (doReset) reset();
}

function loadStoredDuration() {
  try {
    const stored = parseInt(localStorage.getItem(DURATION_STORAGE_KEY), 10);
    return ALLOWED_DURATIONS.has(stored) ? stored : null;
  } catch {
    return null;
  }
}

document.querySelectorAll('.time-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    setDuration(parseInt(btn.dataset.duration, 10));
  });
});

// ─── Init ────────────────────────────────────────────────────────────────────
const savedDuration = loadStoredDuration();
if (savedDuration !== null) setDuration(savedDuration, { persist: false, doReset: false });
reset();
</script>
</body>
</html>
